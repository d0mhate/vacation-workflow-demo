<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacation Workflow</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="/static/app.js" defer></script>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
  <div id="app">
    <header>
      <div><strong>Vacation Workflow</strong></div>
      <div v-if="user">
        <span>{{ user.first_name }} {{ user.last_name }} ({{ user.username }}, {{ user.role }})</span>
        <span class="badge" title="Unread notifications">{{ unreadCount }}</span>
        <button @click="openProfileModal" class="secondary" style="margin-right: 8px;">
          Профиль
        </button>
        <button @click="logout">Выйти</button>
      </div>
    </header>

    <div v-if="loading">Загрузка...</div>

    <div v-else>
        <div id="toast" class="toast-container"></div>
      <div v-if="!user" class="card login-card">
        <div class="muted login-subtitle">
          Введите логин и пароль, выданные кадровой службой.
        </div>
        <form @submit.prevent="login" class="auth-form">
          <div class="form-group">
            <label for="login-username">Логин</label>
            <input
              id="login-username"
              type="text"
              v-model="loginForm.username"
              required
            >
          </div>
          <div class="form-group">
            <label for="login-password">Пароль</label>
            <input
              id="login-password"
              type="password"
              v-model="loginForm.password"
              required
            >
          </div>
          <div class="form-actions">
            <button type="submit">Войти</button>
          </div>
        </form>
        <div class="error-text" v-if="error">{{ error }}</div>
      </div>

      <div v-else>
        <section v-if="user.role === 'employee'" class="card">
          <div class="muted">Личный кабинет сотрудника. Здесь вы можете видеть остаток отпуска и управлять своими заявками.</div>
            <br>
          <transition name="fade">
            <div v-if="loadingEmployeeData" class="loading-skeleton" style="margin-top: 8px;">
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>

            <div v-else>
              <div>Остаток отпуска: {{ balance }} дней</div>

              <div v-if="balances && balances.length" class="balances-block">
                <h4>Остаток отпусков</h4>
                <table class="simple-table">
                  <thead>
                    <tr>
                      <th>Год</th>
                      <th>Остаток, дней</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr v-for="b in balances" :key="b.id">
                      <td>{{ b.year }}</td>
                      <td>{{ b.days_remaining }}</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <h4>Мои заявки</h4>
              <div v-if="myRequests.length">
                <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:6px 0 4px;">
                  <span class="muted" style="font-size:13px;">Сортировать по:</span>
                  <button type="button" class="secondary" @click="toggleMySort('id')">
                    ID
                    <span v-if="sortMyField === 'id'">
                      <span v-if="sortMyDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                  <button type="button" class="secondary" @click="toggleMySort('period')">
                    Период
                    <span v-if="sortMyField === 'period'">
                      <span v-if="sortMyDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                  <button type="button" class="secondary" @click="toggleMySort('status')">
                    Статус
                    <span v-if="sortMyField === 'status'">
                      <span v-if="sortMyDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                  <button type="button" class="secondary" @click="toggleMySort('confirmed')">
                    Подтверждено
                    <span v-if="sortMyField === 'confirmed'">
                      <span v-if="sortMyDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                </div>
                <div class="requests-grid">
                  <div
                    v-for="req in sortedMyRequests"
                    :key="req.id"
                    class="request-card"
                    :class="{ 'request-card--not-approved': req.status !== 'approved' }"
                  >
                    <div class="request-card-header">
                      Заявка №{{ req.id }}
                    </div>
                    <div class="request-card-period">
                      Период: {{ req.start_date }} — {{ req.end_date }} ({{ getDaysBetween(req.start_date, req.end_date) }} .дн)
                    </div>
                    <div>
                      Статус:
                      <span
                        class="status-pill"
                        :class="{
                          'status-approved': req.status === 'approved',
                          'status-rejected': req.status === 'rejected',
                          'status-pending': req.status === 'pending'
                        }"
                      >
                        {{ req.status === 'approved'
                          ? 'Согласована'
                          : req.status === 'rejected'
                            ? 'Отклонена'
                            : 'На согласовании' }}
                      </span>
                    </div>
                    <div>
                      Подтверждение:
                      <span
                        :class="req.confirmed_by_employee ? 'request-confirmed-tag' : 'request-not-confirmed-tag'"
                      >
                        {{ req.confirmed_by_employee ? 'Ознакомлен' : 'Не ознакомлен' }}
                      </span>
                    </div>
                    <div class="request-card-footer" v-if="!req.confirmed_by_employee">
                      <button @click="confirmRequest(req.id)">Подтвердить ознакомление</button>
                    </div>
                  </div>
                </div>
              </div>
              <div v-else class="muted" style="text-align:center; margin-top:6px;">
                Заявок пока нет
              </div>
              <h4>Новая заявка</h4>
              <form @submit.prevent="createRequest" class="range-form">
                <div class="range-form-row">
                  <label>
                    Начало:
                    <input
                      type="date"
                      v-model="newRequest.start_date"
                      required
                    >
                  </label>
                  <label>
                    Конец:
                    <input
                      type="date"
                      v-model="newRequest.end_date"
                      required
                    >
                  </label>
                  <button type="submit">Отправить</button>
                </div>
              </form>
            </div>
          </transition>
        </transition>

      </section>

        <section v-if="user.role === 'manager'" class="card">
          <h3>Заявки сотрудников</h3>
          <div class="muted">Кабинет руководителя. Вы согласовываете заявки сотрудников вашего подразделения.</div>
          <transition name="fade">
            <div v-if="loadingManagerData" class="loading-skeleton" style="margin-top: 8px;">
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>
            <div v-else>
              <div v-if="managerRequests.length">
                <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:6px 0 4px;">
                  <span class="muted" style="font-size:13px;">Сортировать по:</span>
                  <button type="button" class="secondary" @click="toggleManagerSort('id')">
                    ID
                    <span v-if="sortManagerField === 'id'">
                      <span v-if="sortManagerDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                  <button type="button" class="secondary" @click="toggleManagerSort('period')">
                    Период
                    <span v-if="sortManagerField === 'period'">
                      <span v-if="sortManagerDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                  <button type="button" class="secondary" @click="toggleManagerSort('status')">
                    Статус
                    <span v-if="sortManagerField === 'status'">
                      <span v-if="sortManagerDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                  <button type="button" class="secondary" @click="toggleManagerSort('confirmed')">
                    Подтверждено
                    <span v-if="sortManagerField === 'confirmed'">
                      <span v-if="sortManagerDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                </div>
                <div class="requests-grid">
                  <div
                    v-for="req in sortedManagerRequests"
                    :key="req.id"
                    class="request-card"
                    :class="{
                      'request-card--approved': req.status === 'approved',
                      'request-card--not-approved': req.status !== 'approved'
                    }"
                  >
                    <div class="request-card-header">
                      Заявка №{{ req.id }} —  {{ req.user.first_name }} {{ req.user.last_name }}
                    </div>
                    <div class="request-card-period">
                      Период: {{ req.start_date }} — {{ req.end_date }}
                    </div>
                    <div>
                      Статус:
                      <span
                        class="status-pill"
                        :class="{
                          'status-approved': req.status === 'approved',
                          'status-rejected': req.status === 'rejected',
                          'status-pending': req.status === 'pending'
                        }"
                      >
                        {{ req.status === 'approved'
                          ? 'Согласована'
                          : req.status === 'rejected'
                            ? 'Отклонена'
                            : 'На согласовании' }}
                      </span>
                    </div>
                    <div>
                      Подтверждение сотрудником:
                      <span
                        :class="req.confirmed_by_employee ? 'request-confirmed-tag' : 'request-not-confirmed-tag'"
                      >
                        {{ req.confirmed_by_employee ? 'Ознакомлен' : 'Не ознакомлен' }}
                      </span>
                    </div>
                    <div class="request-card-footer">
                      <button @click="approveRequest(req.id)">Согласовать</button>
                      <button @click="rejectRequest(req.id)">Отклонить</button>
                    </div>
                  </div>
                </div>
              </div>
              <div v-else class="muted" style="text-align:center; margin-top:6px;">
                Заявок пока нет
              </div>
            </div>
          </transition>
        </section>
        <section v-if="user.role === 'hr'" class="card">
          <h2 class="card-title">Календарный график отпусков (по месяцам)</h2>
          <p class="muted" style="margin-bottom: 8px;">
            По строкам сотрудники, по столбцам месяцы {{ hrScheduleYear }} года. Точка в ячейке означает, что в этот месяц у сотрудника есть утверждённый отпуск.
          </p>

          <div v-if="loadingHrSchedule" class="table-skeleton">
            Загрузка календарного графика...
          </div>

          <div v-else class="calendar-grid-wrapper">
            <table class="table calendar-table">
              <thead>
                <tr>
                  <th>Сотрудник</th>
                  <th v-for="month in 12" :key="month">
                    {{ ['Янв','Фев','Мар','Апр','Май','Июн','Июл','Авг','Сен','Окт','Ноя','Дек'][month - 1] }}
                  </th>
                </tr>
              </thead>
              <tbody>
                <tr v-if="hrSchedule.length === 0">
                  <td :colspan="13" class="muted">
                    На {{ hrScheduleYear }} год согласованных отпусков пока нет
                  </td>
                </tr>
                <tr v-for="row in hrSchedule" :key="'grid-' + row.user_id">
                  <td>
                    <div class="user-cell">
                      <div class="user-name">{{ row.full_name }}</div>
                      <div class="user-login muted">{{ row.username }}</div>
                    </div>
                  </td>
                  <td v-for="month in 12" :key="month">
                    <div
                      class="month-cell"
                      v-if="row.periods && row.periods.some(p => {
                        const start = new Date(p.start_date);
                        const end = new Date(p.end_date);
                        const m = month - 1;
                        const y = hrScheduleYear;
                        return (
                          (start.getFullYear() < y || (start.getFullYear() === y && start.getMonth() <= m)) &&
                          (end.getFullYear() > y || (end.getFullYear() === y && end.getMonth() >= m))
                        );
                      })"
                    >
                      •
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </section>

        <section v-if="user.role === 'hr'" class="card">
          <h3>Все заявки</h3>
          <div class="muted">Кабинет кадровой службы. Здесь вы работаете со сводным графиком отпусков.</div>
          <button @click="exportCsv" class="btn-primary" style="margin-top: 8px;">Экспорт в CSV</button>
          <transition name="fade">
            <div v-if="loadingHrData" class="loading-skeleton" style="margin-top: 8px;">
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>
            <div v-else>
              <div v-if="hrRequests.length">
                <div style="display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:6px 0 4px;">
                  <span class="muted" style="font-size:13px;">Сортировать по:</span>
                  <button type="button" class="secondary" @click="toggleHrSort('id')">
                    ID
                    <span v-if="sortHrField === 'id'">
                      <span v-if="sortHrDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                  <button type="button" class="secondary" @click="toggleHrSort('period')">
                    Период
                    <span v-if="sortHrField === 'period'">
                      <span v-if="sortHrDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                  <button type="button" class="secondary" @click="toggleHrSort('status')">
                    Статус
                    <span v-if="sortHrField === 'status'">
                      <span v-if="sortHrDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                  <button type="button" class="secondary" @click="toggleHrSort('confirmed')">
                    Подтверждено
                    <span v-if="sortHrField === 'confirmed'">
                      <span v-if="sortHrDirection === 'asc'">↑</span>
                      <span v-else>↓</span>
                    </span>
                  </button>
                </div>
                <div class="requests-grid">
                  <div
                    v-for="req in sortedHrRequests"
                    :key="req.id"
                    class="request-card"
                    :class="{
                      'request-card--approved': req.status === 'approved',
                      'request-card--not-approved': req.status !== 'approved'
                    }"
                  >
                    <div class="request-card-header">
                      Заявка №{{ req.id }} — {{ req.user.first_name }} {{ req.user.last_name }}
                    </div>
                    <div class="request-card-period">
                      Период: {{ req.start_date }} — {{ req.end_date }}
                    </div>
                    <div>
                      Статус:
                      <span
                        class="status-pill"
                        :class="{
                          'status-approved': req.status === 'approved',
                          'status-rejected': req.status === 'rejected',
                          'status-pending': req.status === 'pending'
                        }"
                      >
                        {{ req.status === 'approved'
                          ? 'Согласована'
                          : req.status === 'rejected'
                            ? 'Отклонена'
                            : 'На согласовании' }}
                      </span>
                    </div>
                    <div>
                      Подтверждение сотрудником:
                      <span
                        :class="req.confirmed_by_employee ? 'request-confirmed-tag' : 'request-not-confirmed-tag'"
                      >
                        {{ req.confirmed_by_employee ? 'Ознакомлен' : 'Не ознакомлен' }}
                      </span>
                    </div>
                  </div>
                </div>
              </div>
              <div v-else class="muted" style="text-align:center; margin-top:6px;">
                Заявок пока нет
              </div>
            </div>
          </transition>
        </section>

        <section v-if="user.role === 'manager' || user.role === 'hr'" class="card">
          <h2 class="card-title">Таблицы отпусков на год</h2>
          <div v-if="balances && balances.length">
            <table class="simple-table">
              <thead>
                <tr>
                  <th>Сотрудник</th>
                  <th>Год</th>
                  <th>Остаток, дней</th>
                </tr>
              </thead>
              <tbody>
                <tr v-for="b in balances" :key="b.id">
                  <td>
                    {{ b.user.first_name || '' }} {{ b.user.last_name || '' }}
                    <span class="muted" v-if="!b.user.first_name && !b.user.last_name">
                      ({{ b.user.username }})
                    </span>
                  </td>
                  <td>{{ b.year }}</td>
                  <td>{{ b.days_remaining }}</td>
                </tr>
              </tbody>
            </table>
          </div>
          <div v-else class="muted" style="margin-top: 4px;">Нет данных по остаткам отпусков.</div>
        </section>

        <section v-if="user.role === 'hr'" class="card">
          <div class="card-header-row">
            <h2 class="card-title">График отпусков на год</h2>
            <div class="year-switcher">
              <button class="btn-secondary-small"
                      @click="setHrScheduleYear(hrScheduleYear - 1)">
                ← {{ hrScheduleYear - 1 }}
              </button>
              <span class="year-label">{{ hrScheduleYear }}</span>
              <button class="btn-secondary-small"
                      @click="setHrScheduleYear(hrScheduleYear + 1)">
                {{ hrScheduleYear + 1 }} →
              </button>
            </div>
          </div>

          <!-- Скелет, пока грузится -->
          <div v-if="loadingHrSchedule" class="table-skeleton">
            Загрузка графика отпусков...
          </div>

          <!-- Таблица графика -->
          <table v-else class="table">
            <thead>
              <tr>
                <th>Сотрудник</th>
                <th>Периоды отпусков (утвержденные)</th>
              </tr>
            </thead>
            <tbody>
              <tr v-if="hrSchedule.length === 0">
                <td colspan="2" class="muted">
                  На {{ hrScheduleYear }} год согласованных отпусков пока нет
                </td>
              </tr>
              <tr v-for="row in hrSchedule" :key="row.user_id">
                <td>
                  <div class="user-cell">
                    <div class="user-name">{{ row.full_name }}</div>
                    <div class="user-login muted">{{ row.username }}</div>
                  </div>
                </td>
                <td>
                  <div class="period-chips">
                    <span v-for="p in row.periods"
                          :key="p.id"
                          class="chip chip-period">
                      {{ p.start_date }} — {{ p.end_date }} ( {{ getDaysBetween(p.start_date, p.end_date) }} дн. )
                      <span v-if="!p.confirmed_by_employee" class="chip-sub">
                        (без подтверждения сотрудника)
                      </span>
                    </span>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </section>
        <section class="card">
          <div class="card-header">
            <div>
              <h3>Уведомления</h3>
              <div class="muted">Напоминания о заявках и предстоящих отпусках</div>
            </div>
          </div>

          <transition name="fade">
            <div v-if="loadingNotifications" class="loading-skeleton">
              <div class="skeleton-line"></div>
              <div class="skeleton-line"></div>
              <div class="skeleton-line short"></div>
            </div>

            <div v-else-if="notifications.length === 0" class="muted" style="padding: 12px; text-align: center;">
              Уведомлений нет
            </div>

            <ul v-else>
              <li v-for="n in notifications" :key="n.id">
                <div>
                  <span class="tag-unread" v-if="!n.is_read">Непрочитано</span>

                  <!-- Человекочитаемый тип уведомления -->
                  <span v-if="n.type === 'vacation_reminder_14d'">
                    [Напоминание: до начала отпуска 14 дней]
                  </span>
                  <span v-else-if="n.type === 'vacation_start_today'">
                    [Сегодня начинается отпуск]
                  </span>
                  <span v-else-if="n.type === 'request_submitted'">
                    [Новая заявка на отпуск]
                  </span>
                  <span v-else-if="n.type === 'request_approved'">
                    [Заявка согласована]
                  </span>
                  <span v-else-if="n.type === 'request_rejected'">
                    [Заявка отклонена]
                  </span>
                  <span v-else-if="n.type === 'request_confirmed'">
                    [Сотрудник ознакомился с решением]
                  </span>
                </div>

                <div class="notification-message">
                  {{ n.message }}
                </div>

                <div class="muted" style="font-size: 12px; margin: 4px 0 6px;">
                  {{ new Date(n.created_at).toLocaleString() }}
                </div>

                <button v-if="!n.is_read" class="secondary" @click="markNotificationRead(n.id)">
                  Отметить прочитанным
                </button>
              </li>
            </ul>
          </transition>
        </section>
      </div>
    </div>
    <div v-if="showProfileModal" class="modal-backdrop">
      <div class="modal">
        <h3>Редактирование профиля</h3>
        <form @submit.prevent="saveProfile">
          <label>Имя: <input type="text" v-model="profileForm.first_name" required></label>
          <label>Фамилия: <input type="text" v-model="profileForm.last_name" required></label>
          <div class="modal-actions">
            <button type="submit">Сохранить</button>
            <button type="button" class="secondary" @click="showProfileModal = false">Отмена</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</body>
</html>
